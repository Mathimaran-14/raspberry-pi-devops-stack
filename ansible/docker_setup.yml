---
- name: Install and Configure Docker (Phase 2 Setup)
  hosts: nas_servers
  become: yes
  
  tasks:
    - name: 1. Install required dependencies and build tools
      ansible.builtin.apt:
        name: 
          - python3-pip
          - curl
          - apt-transport-https
          - ca-certificates
          - gnupg2
          - build-essential # Essential for Docker Compose compilation
        state: present
        update_cache: yes
        
    - name: 2. Install Docker using the official get-docker script
      ansible.builtin.shell: |
        curl -fsSL https://get.docker.com -o get-docker.sh
        sh get-docker.sh
      args:
        creates: /usr/bin/docker # Prevents re-running if Docker is already installed

    - name: 3. Install Docker Compose (Pre-compiled Binary for ARM)
      vars:
        # Using a stable, known working version for ARMv7/ARM64 compatibility
        docker_compose_version: "2.23.3" 
      ansible.builtin.shell: |
        curl -L "https://github.com/docker/compose/releases/download/v{{ docker_compose_version }}/docker-compose-linux-armv7" -o /usr/local/bin/docker-compose
        chmod +x /usr/local/bin/docker-compose
      args:
        creates: /usr/local/bin/docker-compose # Prevents re-running this task

    - name: 4. Add remote user ('maran') to the docker group
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes
      
    - name: 5. Restart the Docker daemon to apply group changes
      ansible.builtin.service:
        name: docker
        state: restarted
